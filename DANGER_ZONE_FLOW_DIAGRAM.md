# ๐บ๏ธ Danger Zone - Fluxo Completo

## ๐ Arquitetura Visual

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           CHARGE MIND APP                               โ
โ                         (React + TypeScript)                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                     โ
                                     โ User clicks "Delete Account"
                                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         Settings.tsx Component                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ                          Danger Zone Section                        โ โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ โ
โ โ โ  ๐ด Deactivate Account                                         โ  โ โ
โ โ โ  Once you delete your account, there is no going back...      โ  โ โ
โ โ โ                                            [Delete Account]   โ  โ โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                     โ
                                     โ onClick
                                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         AlertDialog Modal                               โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ  Deactivate and Uninstall?                                          โ โ
โ โ                                                                     โ โ
โ โ  This will cancel your subscription immediately, remove your       โ โ
โ โ  account data, and uninstall the app from your store. This        โ โ
โ โ  action cannot be undone.                                         โ โ
โ โ                                                                     โ โ
โ โ              [Cancel]  [Uninstall App & Delete Data]              โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                     โ
                                     โ User confirms
                                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      handleDeleteAccount()                              โ
โ                                                                         โ
โ  1. setIsDeletingAccount(true)                                         โ
โ  2. toast.promise(uninstallPromise())                                  โ
โ     โโ loading: "Uninstalling app..."                                 โ
โ     โโ success: "App uninstalled successfully..."                     โ
โ     โโ error: [Error message]                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                     โ
                                     โ supabase.functions.invoke()
                                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       SUPABASE EDGE FUNCTION                            โ
โ                    supabase/functions/app-uninstall                     โ
โ                                                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ STEP 1: Authentication                                            โ โ
โ  โ โโ Get JWT token from Authorization header                       โ โ
โ  โ โโ Validate user with supabase.auth.getUser()                    โ โ
โ  โ โโ Get user ID                                                    โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ STEP 2: Get Client Data                                          โ โ
โ  โ โโ Query users table for client_id                               โ โ
โ  โ โโ Query clients table for Shopify credentials                   โ โ
โ  โ โ  โโ shopify_store_name                                         โ โ
โ  โ โ  โโ shopify_access_token                                       โ โ
โ  โ โโ Validate data exists                                          โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ STEP 3: Call Shopify GraphQL API                                 โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ โ POST https://{store}.myshopify.com/admin/api/2024-10/graphql โ โ โ
โ  โ โ Headers:                                                      โ โ โ
โ  โ โ   X-Shopify-Access-Token: {access_token}                     โ โ โ
โ  โ โ Body:                                                         โ โ โ
โ  โ โ   {                                                           โ โ โ
โ  โ โ     "query": "mutation { appUninstall { userErrors { ... }}}"โ โ โ
โ  โ โ   }                                                           โ โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ โ                                                                 โ โ
โ  โ โโ Success: App uninstalled from Shopify โ                      โ โ
โ  โ โโ Subscription canceled automatically by Shopify โ             โ โ
โ  โ โโ If fails: Log warning, continue anyway (fallback)            โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ STEP 4: Clean Local Data                                         โ โ
โ  โ UPDATE clients SET                                                โ โ
โ  โ   shopify_store_name = NULL,                                     โ โ
โ  โ   shopify_access_token = NULL,                                   โ โ
โ  โ   shopify_connected_at = NULL,                                   โ โ
โ  โ   shopify_status = 'uninstalled',                                โ โ
โ  โ   account_status = 'deactivated',                                โ โ
โ  โ   deactivated_at = NOW()                                         โ โ
โ  โ WHERE id = {client_id}                                           โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ STEP 5: Deactivate Users                                         โ โ
โ  โ UPDATE users SET active = FALSE                                  โ โ
โ  โ WHERE client_id = {client_id}                                    โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ STEP 6: Return Success                                           โ โ
โ  โ { success: true, message: "App uninstalled successfully" }       โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                     โ
                                     โ Response
                                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      Frontend (Settings.tsx)                            โ
โ                                                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ Toast Success: "App uninstalled successfully..."                 โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ setShowDeleteAccountDialog(false)                                โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ await supabase.auth.signOut()                                    โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ await delay(1500ms) // Wait for toast                            โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                              โ                                          โ
โ                              โผ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ window.open("https://admin.shopify.com", "_top")                 โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                     โ
                                     โ Redirect
                                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                          SHOPIFY ADMIN                                  โ
โ                      https://admin.shopify.com                          โ
โ                                                                         โ
โ  User is now logged out from ChargeMind                                โ
โ  App is uninstalled from their store                                   โ
โ  Subscription has been canceled                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Fluxo de Erro

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Error in any step                  โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Catch error                        โ
โ console.error(error)               โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Toast Error                        โ
โ "Failed to uninstall app..."       โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ setIsDeletingAccount(false)        โ
โ Keep modal open for retry          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐๏ธ Database Changes

```
BEFORE:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ clients table                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id: uuid                                        โ
โ email: text                                     โ
โ shopify_store_name: "mystore.myshopify.com"    โ
โ shopify_access_token: "shpat_abc123..."        โ
โ shopify_status: "active"                        โ
โ shopify_connected_at: "2024-01-15T10:00:00Z"   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

AFTER UNINSTALL:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ clients table                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id: uuid                                        โ
โ email: text                                     โ
โ shopify_store_name: NULL                        โ
โ shopify_access_token: NULL                      โ
โ shopify_status: "uninstalled"                   โ
โ shopify_connected_at: NULL                      โ
โ account_status: "deactivated" โโโ NEW          โ
โ deactivated_at: "2024-12-17T15:30:00Z" โโโ NEW โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ users table                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ id: uuid                                        โ
โ client_id: uuid                                 โ
โ email: text                                     โ
โ active: FALSE โโโ Changed from TRUE             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โก Performance Timeline

```
0ms     โโ User clicks button
        โ
50ms    โโ Modal opens
        โ
        โ  (User reads confirmation)
        โ
2000ms  โโ User confirms
        โ
2010ms  โโ Toast "Uninstalling app..." appears
        โ
2020ms  โโ Edge Function invoked
        โ
2100ms  โ  โโ Auth check (80ms)
        โ  โ
2300ms  โ  โโ Get client data (200ms)
        โ  โ
4000ms  โ  โโ Shopify GraphQL call (1700ms) โโโ Longest step
        โ  โ
4200ms  โ  โโ Update clients table (200ms)
        โ  โ
4300ms  โ  โโ Update users table (100ms)
        โ  โ
4310ms  โ  โโ Return success (10ms)
        โ
4320ms  โโ Toast "App uninstalled successfully..."
        โ
4330ms  โโ Close modal
        โ
4400ms  โโ Sign out (70ms)
        โ
5900ms  โโ Wait for toast visibility (1500ms)
        โ
5910ms  โโ Redirect to Shopify
        
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
Total: ~6 seconds
```

---

## ๐ฏ Success Criteria

```
โ User clicked "Delete Account"
โ Modal opened with correct text
โ User confirmed action
โ Toast loading state visible
โ Edge Function authenticated user
โ Shopify GraphQL mutation called
โ Shopify returned success (or logged warning)
โ Database credentials cleared
โ Account status set to 'deactivated'
โ All users deactivated
โ Toast success message shown
โ User logged out
โ Redirected to admin.shopify.com
```

---

## ๐ Security Checkpoints

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. Modal Confirmation             โ  โโโ UX Safety
โ    โโ Explicit action required    โ
โ    โโ Cancel button in focus      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ
                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. JWT Authentication             โ  โโโ Identity Verification
โ    โโ Valid token required        โ
โ    โโ Token not expired           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ
                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. Client Ownership               โ  โโโ Authorization
โ    โโ User belongs to client      โ
โ    โโ Client_id matches           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ
                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. Shopify API Call               โ  โโโ External Validation
โ    โโ Valid access token          โ
โ    โโ Store exists                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ
                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 5. Audit Logging                  โ  โโโ Accountability
โ    โโ All actions logged          โ
โ    โโ Timestamps recorded         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Legenda:**
- `โโ` = Prรณximo passo
- `โโ` = รltimo passo
- `โผ` = Fluxo continua
- `โโโ` = Nota adicional
- `โ` = Checkpoint de sucesso
